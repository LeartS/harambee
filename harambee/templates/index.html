{% extends "layout.html" %}

{% block body %}
<div class="jumbotron">
  <h1>Welcome to Harambee!</h1>
  <p>
    Benvenuto su Harambee, una piattaforma dedicata al miglioramento dei luoghi in cui vivi.
  </p>
  <br><br>
  <p>Per cominciare, cerca il tuo comune:</p>
  <div class="row">
    <div class="col-md-12">
      <form class="" action="/search" method="GET">
      <div class="input-group input-group-lg">
        <input id="city" class="typeahead input-large form-control" type="search" name="city">
        <span class="input-group-btn">
          <input class="btn btn-default" type="submit" value="Go">
        </span>
      </div>
      </form>
    </div>
  </div>
  <script>
    window.onload = function() {
        {% raw %}
        cityTemplate = Hogan.compile(
            "<h3>{{name}}</h3> {{bug_count}} segnalazioni, {{reporters_count}} contribuenti"
        );
        emptyTemplate = Hogan.compile(
            "<div class=\"tt-suggestion\"><h3>Crea la tua citt√†!</h3></div>"
        );
        {% endraw %}
        var engine = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            prefetch: {
                url: '{{ url_for('cities_preview') }}',
                filter: function(json) { return json.cities; },
            }
        });
        engine.clearPrefetchCache(); // for development
        engine.initialize();
        $('#city').typeahead({
            hint: true,
            minLength: 1,
            autoselect: true,
        }, {
            name: 'cities',
            displayKey: 'name',
            source: engine.ttAdapter(),
            templates: {
                suggestion: cityTemplate.render.bind(cityTemplate),
                empty: emptyTemplate.render.bind(emptyTemplate),
            }
        })
        .on('typeahead:selected', function(event, data, dataset) {
            /*
               I'd love a better way to do this. And I'm not mad, the
               url is generated by a jinja2 template which you can't see,
               that's why I replace it instead of just putting the correct values.
             */
            window.location.href = "{{ url_for('city', city_id=0, city='xxx') }}"
                .replace('0', data.id).replace('xxx', data.name);
        });
        $('.tt-hint').addClass('form-control');
    }
  </script>
</div>
{% endblock %}
